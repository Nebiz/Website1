<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipe Form</title>
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/recipe.css">
  <script type="text/javascript" src="lib/purify.min.js"></script>
</head>

<body>

  <!-- 1. Navbar -->
  <nav class="navbar navbar-light">
    <div class="container" style="max-width: 600px;">
      <!-- Logo and Title -->
      <a class="navbar-brand" href="index.html">
        <img src="img/logo.png" alt="Logo">
        <span class="navbar-text">Ben's Book</span>
      </a>
    </div>
  </nav>

  <div id="MainContent" class="container mb-2">
    <h1 class="fw-bold text-primary">Nouvelle Recette</h1><br>
    <form id="recipeForm" autocomplete="off">
      <input autocomplete="false" name="hidden" type="text" style="display:none;">

      <div class="form-floating mb-3">
        <input type="text" id="title" class="form-control" name="title" placeholder="Titre">
        <label for="title">Titre</label>
      </div>

      <div class="form-floating mb-3">
        <textarea id="author" class="form-control dynamic-textarea" name="author" placeholder="Auteur"></textarea>
        <label for="author">Auteurs</label>
      </div>

      <div class="form-floating mb-3">
        <textarea id="description" class="form-control dynamic-textarea" name="description"
          placeholder="Description"></textarea>
        <label for="description">Description</label>
      </div>

      <div class="form-floating mb-3">
        <input type="text" id="prep_time" class="form-control" name="prep_time" placeholder="Temps de préparation">
        <label for="prep_time">Temps de préparation</label>
      </div>

      <div class="form-floating mb-3">
        <input type="text" id="cook_time" class="form-control" name="cook_time" placeholder="Temps de cuisson">
        <label for="cook_time">Temps de cuisson</label>
      </div>

      <div class="form-floating mb-3">
        <input type="text" id="total_time" class="form-control" name="total_time" placeholder="Temps total">
        <label for="total_time">Temps total</label>
      </div>

      <div class="form-floating mb-3">
        <input type="text" id="servings" class="form-control" name="servings" placeholder="Portions">
        <label for="servings">Portions</label>
      </div>

      <div class="form-floating mb-3">
        <textarea id="ingredients" class="form-control dynamic-textarea" name="ingredients"
          placeholder="Ingrédients"></textarea>
        <label for="ingredients">Ingrédients</label>
      </div>

      <div class="form-floating mb-3">
        <textarea id="instructions" class="form-control dynamic-textarea" name="instructions"
          placeholder="Instructions"></textarea>
        <label for="instructions">Instructions</label>
      </div>

      <div class="form-floating mb-3">
        <textarea id="tags" class="form-control dynamic-textarea" name="tags" placeholder="Tags"></textarea>
        <label for="instructions">Tags</label>
      </div>

      <input type="submit" value="Submit">
    </form>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script>
    $(document).ready(function () {
      setDynamicTextarea();
      $("#recipeForm").on("submit", function (event) {
        event.preventDefault();
        var recipeJSON = formToJSON();
        downloadJSON(recipeJSON);
      });
    });

    // Parsa data from the from into JSON obj.
    function formToJSON() {
      const recipeData = {
        recipe: {
          file_name: self.crypto.randomUUID(),
          title: $("#title").val(),
          author: $("#author").val().split("\s").filter(item => item !== ""),
          description: $("#description").val(),
          prep_time: $("#prep_time").val(),
          cook_time: $("#cook_time").val(),
          total_time: $("#total_time").val(),
          servings: $("#servings").val(),
          ingredients: $("#ingredients").val().split("\n"), //.filter(item => item !== ""),
          instructions: $("#instructions").val().split("\n"), //.filter(item => item !== ""),
          tags: $("#tags").val().split(/\s+/).filter(item => item !== ""),
          date_created: new Date().toUTCString()
        }
      };
      return recipeData;
    }
    // Download Recipe as json locally.
    function downloadJSON(content) {
      const link = document.createElement("a");
      const Sanitize = DOMPurify.sanitize(JSON.stringify(content, null, 2));
      const blob = new Blob([Sanitize], { type: "application/json" });

      link.href = URL.createObjectURL(blob);
      link.download = content.recipe.file_name; // file name

      link.click();
      link.remove();
    }
    function setDynamicTextarea() {
      const textareas = $(".dynamic-textarea");
      // Reset and set new height to adjust content dynamically
      textareas.on("input", function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });
      textareas.each(function () {
        // this.setAttribute("rows", 1); // Disabled: Force textarea to only 1 line of height when only 1 line of text
        this.style.overflow = "hidden"; // hide scrollbar
      });
    }

  </script>

  <style type="text/css">
    #MainContent {
      max-width: 600px;
    }

    body {
      background-color: rgb(213, 213, 255);
    }
  </style>
</body>

</html>