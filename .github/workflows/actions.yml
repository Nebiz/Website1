name: Update JSON Index - file listing all files in 'json' folder

on:
  push:
    paths:
      - 'json/**'

jobs:
  update-json-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch the last two commits to compare

      - name: Check for file additions or deletions
        id: check_changes
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            added=$(git diff --name-status HEAD^ HEAD | grep '^A' | grep 'json/' | wc -l)
            deleted=$(git diff --name-status HEAD^ HEAD | grep '^D' | grep 'json/' | wc -l)
          else
            added=$(git ls-files --others --exclude-standard -- 'json/*' | wc -l)
            deleted=0
          fi

          echo "files_added=$added" >> $GITHUB_ENV
          echo "files_deleted=$deleted" >> $GITHUB_ENV

      - name: Generate JSON index file if files were added or removed
        if: ${{ env.files_added != '0' || env.files_deleted != '0' }}
        run: |
          files=$(ls json | jq -R -s -c 'split("\n") | map(select(. != "")) | map("\"" + . + "\"") | "[" + join(",\n") + "]"')
          echo "$files" > json_index.json

          git config --global user.name 'github-actions[bot]'
          git add json_index.json
          git commit -m "Update JSON index"

      - name: Push changes
        if: ${{ env.files_added != '0' || env.files_deleted != '0' }}
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
